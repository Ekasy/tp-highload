# Проектирование высоконагруженных систем
[Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

# 1. Тема и целевая аудитория

## Тема - Discord
[**Discord**](https://discord.com/) - система мнгновенного обмена сообщениями с поддержкой VoiP и видеоконференций, предназначенная для использования различными сообществами по интересам.


## MVP
1. Регистрация и авторизация
2. Создание сервера
    1. Поддержка системы ролей
        1. Админы сервера
        2. Пользователи
    2. Создание каналов
        1. Текстовый канал (чат)
        2. Голосовой канал (голосовой чат)
3. Текстовые сообщения
    - максимальная длина сообщения 2000 символов
    - прикрепление документа к сообщению. максимальный размер 8мб
4. Голосовые звонки
    - поддержка стриминга экрана


## Целевая аудитория
Основываясь на источниках [[1]](https://levvvel.com/discord-statistics-and-facts/) и [[2]](https://www.businessofapps.com/data/discord-statistics/)

Основная целевая аудитория - люди в возрасте от 12 до 45 лет, интересующиеся играми, стримингом

Средний возраст пользователя - 20 лет

### Размер
- 390млн зарегестрированных пользователей (на 2021 год)
- 150млн активных пользователей за месяц (на 2021 год)
- 14млн активных пользователей в день (на 2019 год)
- 19млн активных серверов в неделю (на 2021 год)

### Местоположение
Дополнительно основываясь на [[3]](https://www.similarweb.com/ru/website/discordapp.com/#traffic)
| # | Страна                    | Процент аудитории |
| - | :------------------------ | :---------------: |
| 1 | Соединенные штаты америки | 27.61%            |
| 2 | Канада                    | 5.58%             |
| 3 | Великобритания            | 3.91%             |
| 4 | Германия                  | 3.43%             |
| 5 | Франция                   | 3.43%             |

Приведу следующую оценку
| # | Регион                    | Процент аудитории |
| - | :------------------------ | :---------------: |
| 1 | Северная америка          | 35%               |
| 2 | Европа                    | 18%               |
| 3 | Азия                      | 18%               |
| 4 | Южная америка             | 14.5%             |
| 5 | Африка                    | 14.5%             |


# 2. Расчет нагрузки

## Продуктовые метрики

### Месячная аудитория
`150млн`

### Дневная аудитория
`14млн`

### Средний размер хранилища пользователя

#### Анализ текстовых сообщений

Согласно [[1]](https://levvvel.com/discord-statistics-and-facts/) в день Discord обслуживает `960млн` сообщений. Таким образом, каждый пользователь отправляет в день `960 / 14 = 69` сообщений

Общение в текстовом канале таких сервисов как дискорд, зачастую сводится к коротким сообщениям. Но также есть выбросы в виде длинных сообщений, цитат и т.д. Будем считать, что средняя длина сообщений колеблется в районе 200 символов. В таком случае каждый пользователь в день отправляет `69 * 200 = 13800` cимволов. С учетом того, что каждый символ занимает `2 байта` получаем `13800 * 2 = 27600 байт` отправляет пользователь в день.

#### Анализ загружаемых файлов

Также в текстовом канале можно прикреплять файлы, 90% которых будут изображения. Средним размером загружаемого изображения будем считать `0.75 мбайт`. Вес остальных загружаемых файлов `5 мбайт`. Тогда для 100% случаев загрузки файлов получаем `0.75*0.9 + 5*0.1 = 1.175 мбайт`. Исходя из собственного опыта (и в отсутсвии общедоступной статистики) предполаем, что в день пользователь загружает не более 3 картинок (в среднем случае)

#### Анализ пользовательской мета-информации

В качестве пользовательской информации считаем:
- id (строка до 32 символов = 32 байта)
- login (строка до 32 символов = 32 байта)
- password (строка до 16 символов = 16 байт)
- почта (строка до 64 символов 64 байта)
- timestamp присоединения к сервису (число = 8 байт)
- аватарка (изображение в среднем 1мб)

#### Итого
Бум дискорда произошел в [2018 году](https://www.businessofapps.com/data/discord-statistics/). Поэтому оценка среднего возраста аккаунта в 4 года - состоятельна.
- сообщения: `27600 * 365 * 4 / 2^20 = 38.4 мбайт`
- файлы: `1.175 * 3 * 365 * 4 = 5146.5 мбайт`
- пользовательская метаинформация: `(32 + 32 + 16 + 64 + 8) / 2^20 + 1 = 1 мбайт`
- итого: `38.4 + 5146.5 + 1 = 5185.9`

### Среднее количество действий пользователя по типам в день

- обычный пользователь заходит в систему 2 раза в день: утром (проверить историю сообщений) и вечером (полноценное общение после работы)
- на основе [статистики](https://www.businessofapps.com/data/discord-statistics/), за 2 года число серверов увеличилось с 4.4 до 6.7 млн. Значит в день создается `(6.7 - 4.4) / (2 * 365) = 3150` серверов. При условии, что большинство серверов создалось в начале истории сервиса, будем полагать, что в день сейчас создается не более половины, что значительно меньше ежедновно активных пользователей
- просмотр сообщений / файлов происходит в 5 раз чаще
- участие в голосовом чате не более 3-х раз в день
- участие в трансляции ~ 1 раз

| Действие                    | Количество в день |
| :-------------------------- | :---------------: |
| Авторизация                 | 2                 |
| Создание сервера / канала   | 0                 |
| Отправка текстого сообщения | 69                |
| Отправка файла              | 3                 |
| Просмотр сообщений          | 345               |
| Просмотр файла              | 15                |
| Участие в голосовом канале  | 3                 |
| Участие в трансляции        | 1                 |


## Технические метрики

### Размер хранения в разбивке по типам данных (в Тб)

Напомним, 390 млн - число зарегистрированных пользователей. В день активно 14 млн => начиная с 2017 года прошло 5 лет. Подсчитаем размер хранилища за 5 лет:
- автарки: `(1 * 390*10^6) / 2^20 = 372 Тб`
- сообщения: `(38.4 * 14*10^6 * 365 * 5) / 2^20 = 935669 Тб`
- файлы: `(5146.5 * 14*10^6 * 365 * 5) / 2^20 = 125401568 Тб`
- итого: `372 + 935669 + 125401568 = 126337609 Тб` для хранения 5-ти летней истории

### Сетевой трафик

Discord используют в основном в вечерне-ночное время с 19 до 01 (после работы). Будем считать эти 6 часов - пиковыми

#### Авторизация
Не существенно

#### Создание сервера / канала
Не существенно

#### Отправка сообщений (входящий трафик)
- ежедневно отправляется 960 млн. сообщений
- средняя длина сообщения 200 символов / 400 байт
- трафик (Гбайт / сутки): `960*10^6 * 400 / 2^30 = 357.6`
- трафик (Гбит / с): `357.6 * 8 / (60 * 60) = 0.792`

#### Отправка сообщений (исходящий трафик)
- чтение сообщений происходит чаще записи в 5 раз
- трафик: `0.792 * 5 = 3.96 Гбит / с`

#### Отправка файлов (входящий трафик)
- ежедневно пользователь отправляет 3 файла
- ежедневно активно 14 млн пользователей
- средний размер файла 1.175 мбайт
- трафик (Гбайт / сутки): `3 * 14*10^6 * 1.175 / 2^10 = 48193.4`
- трафик (Гбит / с): `48193.4 * 8 / (60 * 60) = 107.04`

#### Отправка файлов (исходящий трафик)
- просмотр файлов происходит в 5 раз чаще отправки
- трафик: `107.04 * 5 = 535.2 Гбит / с`

#### [Голосовое общение](https://influencermarketinghub.com/discord-stats/#toc-2)
Архитектурно в реализации голосового общения на каждого пользователя создается 2 потока: входящий и исходящий (в который на сервере смешивают все потоки остальных участников голосового канала).
Будем считать, по большей части, в голосовом канале активно участвуют лишь 4 человека
- качество аудиопотока 64 кбит / с
- количество ежедневного голосового общения - 4 млрд. мин / день
- `4 чел * 4*10^9 мин/сутки = 16` млрд. мин аудиопотока / сутки
- трафик (Гбайт / сутки): `16*10^9 * 60с * 64кбит/с / (8бит * 2^20) = 7324218.75`
- трафик (Гбит / с): `7324218.75 * 8 / (60 * 60) = 16276.04`

Посчитанный трафик верен как для входящего, так и для исходящего потока

#### Трансляции
Пусть трансляций в 5 раз меньше голосового общения и на трансляцию используют все те же 4 человека. В таком случае 1 входящий поток видео и 3 исходящих
- качество видео: 720p, 3 байта / px, 30 fps
- размер одного кадра: `1280 * 720px * 24бит/px = 21600 кбит`
- размер видео в секунду: `21600 * 30 = 648000 кбит/с`
- трафик (Гбайт / сутки): `(648000 + 64) * 4*10^9 / 5 / (8 * 2^20) = 61804199.22`
- трафик (Гбит / с): `61804199.22 * 8 / (60 * 60) = 137342.665`

Соответственно получаем:
- входящий трафик: `137342.665 Гбит / с`
- исходящий трафик: `3 * 137342.665 = 412027.995 Гбит / с`

#### Итого
##### Исходящий трафик
| Действие           | Трафик (Гбит / с) | Трафик (Гбайт / сутки) |
| :----------------- | :---------------: | ---------------------: |
| Отправка сообщения | 3.96              | 1782                   |
| Отправка файла     | 535.2             | 239490                 |
| Голосовое общение  | 16276.04          | 7324218.75             |
| Трансляция         | 412027.995        | 185412597.75           |
| Суммарно           | 428843.195        | 1861978088.5           |

##### Входящий трафик
| Действие           | Трафик (Гбит / с) | Трафик (Гбайт / сутки) |
| :----------------- | :---------------: | ---------------------: |
| Отправка сообщения | 0.792             | 357.6                  |
| Отправка файла     | 107.04            | 107.04                 |
| Голосовое общение  | 16276.04          | 7324218.75             |
| Трансляция         | 137342.665        | 61804199.22            |
| Суммарно           | 153726.537        | 625510005.733          |


### RPS в разбивке по типу запроса

- число действий пользователя в день: `2+69+3+345+15+3+1 = 438`
- число активных пользователей в день: `14 млн`
- суммарный RPS: `438 * 14*10^6 / (24 * 60 * 60) = 70972`

| Действие                    | Количество в день | RPS
| :-------------------------- | :---------------: | :---: |
| Авторизация                 | 2                 | 324   |
| Создание сервера / канала   | 0                 | 2     |
| Отправка текстого сообщения | 69                | 11180 |
| Отправка файла              | 3                 | 486   |
| Просмотр сообщений          | 345               | 55902 |
| Просмотр файла              | 15                | 2430  |
| Участие в голосовом канале  | 3                 | 486   |
| Участие в трансляции        | 1                 | 162   |
